# bpftime: 高性能用户态 eBPF 运行时

> 郑昱笙，于桐

eBPF 是一项革命性的技术，起源于 Linux 内核，可以在操作系统的内核中运行沙盒程序。它被用来安全和有效地扩展内核的功能，而不需要改变内核的源代码或加载内核模块。

在这篇 Blog 中，我们希望向大家介绍一个全新的开源用户态 eBPF 运行时：bpftime[1]。bpftime 进一步拓展了 eBPF 的能力，使现有的 eBPF 工具和应用，例如 BCC tools, bpftrace, Deepflow 等，能够不需要进行代码修改即可在非特权用户空间运行，同时使用和内核 eBPF 相同的库和工具链。

bpftime 不仅提供了 Uprobe 和系统调用追踪点等动态追踪或扩展机制，还相比内核 Uprobe 大幅提升了性能，并且和内核 eBPF 一样，无需手动进行代码插桩或重启进程。bpftime 通过用户态共享内存支持进程间 eBPF maps，同时兼容内核 eBPF maps，能够实现与内核 eBPF 基础设施的无缝操作。此外，它包含了针对多种架构的高性能 LLVM JIT/AOT 编译器，以及针对 x86 的轻量级 JIT 和解释器。通过性能数据和实际案例，我们也将展示 bpftime 如何在现实世界中发挥作用，并对其未来发展进行展望，希望 bpftime 能为系统监控、分析和扩展带来前所未有的性能和灵活性。在 Linux plumbers 23 会议上，我们也介绍了 bpftime 的设计和实现[2]。

## eBPF: 从内核态到用户态的系统扩展

eBPF（扩展的 Berkeley Packet Filter）从最初的网络数据包过滤工具，已经演变为一个多功能的系统级扩展技术。自从 20 世纪 90 年代 BPF 的诞生以来，eBPF 通过扩展指令集和与内核数据结构的直接互动，显著增强了其功能。2014 年加入 Linux 内核后，eBPF 成为一个强大的字节码引擎，广泛应用于性能分析、安全策略等领域。随着计算环境的复杂化，eBPF 的实时数据采集和分析能力在现代计算中发挥了重要作用，尤其是在流量控制、负载均衡和安全策略等方面。

虽然 eBPF 最初是为内核设计的，但它在用户空间的巨大潜力，以及内核对于 `GPL LICENSE` 的限制，也催生了例如 ubpf[3] 和 rbpf[4] 这样早期的用户空间 eBPF 运行时的产生。这种运行时使开发者能够在内核之外运行 eBPF字节码，突破了 GPL 许可的限制，同时提供了更加直观和方便的调试环境。但是，编写适用于 ubpf 和 rbpf 的程序可能需要一个特定的、和内核不完全兼容的工具链，同时只有有限的单线程哈希 maps 实现，难以运行实际的 eBPF 程序。另外，ubpf 和 rbpf 本身只是一个执行 eBPF 字节码虚拟机，在实际的使用中，依然需要编写胶水代码，和其他用户空间程序进行编译、链接后才能使用，它们本身也不提供动态追踪的功能。

在实际应用中，用户态 eBPF 已被尝试扩展和应用于网络处理、区块链和安全等领域。例如，Oko 和 DPDK eBPF 支持展示了 eBPF 在网络数据处理中的灵活性和性能优势。Solana 项目利用 eBPF 实现了 JIT 编译器，为区块链智能合约执行提供支持。eBPF for Windows 项目则是将 eBPF 功能扩展到 Linux 之外，展现了 eBPF 在跨平台兼容性方面的潜力。这些应用案例不仅展示了 eBPF 强大的系统扩展能力，也突显了它在现代计算领域的重要性和广泛适用性。

## 为什么我们需要 bpftime

由于操作系统内核的核心作用以及对稳定性和安全性的高要求，操作系统内核的创新和演化相对来说较慢，这也是 eBPF 出现的初衷：在不改变内核源代码的情况下，扩展内核的功能，并进一步带来更多的创新性应用场景[5]。这也是我们希望 bpftime 能够带来的影响：在不改变用户空间程序代码的情况下，借助 eBPF 带来的安全性和生态，探索更多的发展可能性，同时弥补当前内核态 eBPF, 和用户态其他扩展方案可能的不足。

### 内核态实现用户态追踪（Uprobe）的局限性

### 内核态 eBPF 安全性和扩展性的限制

### 其他用户空间扩展方案的不足

## bpftime 能做什么？

## 性能数据和使用案例

## 下一步

## 总结

## 参考资料

[1] bpftime Git repo: <https://github.com/eunomia-bpf/bpftime>
[2] bpftime Linux Plumbers talk: <https://lpc.events/event/17/contributions/1639/>
[3] ubpf: <https://github.com/iovisor/ubpf>
[4] rbpf: <https://github.com/qmonnet/rbpf>

# 用户空间 eBPF 运行时：概述与应用

郑昱笙

在这篇博客文章中，我们将深入探讨用户空间中的 eBPF。尽管许多人熟悉基于内核的 eBPF，但用户空间的 eBPF 运行时已取得了显著的进展，并提供了引人注目的使用案例。我们还将用户空间 eBPF 运行时与 Wasm 运行时进行比较，Wasm 运行时是云原生和边缘计算领域的另一种受欢迎的技术。其中，我们很高兴介绍 [bpftime](https://github.com/eunomia-bpf/bpftime)。通过 LLVM `JIT/AOT` 后端支持，我们的基准测试表明 bpftime 是最快的用户空间 eBPF 运行时之一。

## eBPF 简介

### 什么是 eBPF？

eBPF，代表 "extended Berkeley Packet Filter"，是一项革命性技术，可以在不修改内核源代码或重新启动系统的情况下，动态跟踪和监控内核操作。eBPF 最初是为网络数据包过滤而设计的，但现在已经发展为支持从性能分析到安全性的广泛应用，使其成为系统管理员工具箱中的多功能工具。

eBPF 的故事始于 20 世纪 90 年代初推出的 Berkeley Packet Filter (BPF)，这是一种有效过滤和捕获网络数据包的方法。多年来，BPF 已证明是一种无价之宝，但还有改进的空间。eBPF 作为 BPF 的高级迭代出现，配备了更丰富的指令集并能够直接与内核数据结构互动。

Linux 内核在大约 2014 年采用了 eBPF，从那时起，它的受欢迎程度和采纳率都在飙升。Linux 内核的主要贡献者努力将 eBPF 从一个简单的数据包过滤器发展为一个通用而强大的字节码引擎。

### 在现代计算和网络解决方案中的重要性

在当今复杂的计算环境中，实时数据和洞察的需求至关重要。在这方面，eBPF 表现出色，允许开发者和管理员即时检查和修改系统行为。

鉴于其动态性质，eBPF 已成为现代网络解决方案的基石。它在内核级别实现了精细的流量控制、负载均衡和安全性强制，确保了最佳性能和安全性。此外，在可观察性领域，eBPF 提供了对系统调用、硬件事件等的详细洞察，促进了主动问题检测和解决。

### eBPF：从内核运行时到用户空间运行时

尽管 eBPF 的初步设计深深嵌入于内核中，但对用户空间应用中类似功能的需求导致了用户空间 eBPF 运行时的发展。这些运行时允许开发者在内核之外利用 eBPF 的能力，扩展其实用性和适用性。用户空间 eBPF 运行时使得将 eBPF 的威力应用到更广泛的应用集成为可能，从定制网络协议到新颖的安全解决方案，进一步巩固了 eBPF 作为计算领域中的变革性技术的地位。

## 用户空间 eBPF 运行时及其作用

### 什么是用户空间 eBPF 运行时？

用户空间 eBPF 运行时为 eBPF 程序提供了一个在内核之外的运行平台。虽然 eBPF 的一个突出特点是其在内核空间内执行代码的能力，提供快速的可观察性和数据聚合，但在某些情境下，拥有一个用户空间的替代方案变得非常有价值。这些用户空间运行时扩展了 eBPF 多功能性的范围，超越了内核集成，并常常作为特定用例的实验场地、调试工具或框架。

### 特定运行时简介

#### **ubpf**

[uBPF](https://github.com/iovisor/ubpf) 是将 eBPF 引入用户空间的早期尝试之一。主要作为一个概念证明，它作为 eBPF 解释器的用户空间解释与 x86_64 和 arm64 JIT 的结合。尽管其起源是一个早期原型，uBPF 吸引了注意并被用作高性能网络项目（如 DPDK 和 Oko）的基础。它的非 GPL 许可证（Apache）使其适用于各种项目，包括专有项目。然而，最近，uBPF 正在迎头赶上内核发展，特别是微软为其 eBPF Windows 实现做出的贡献。但是，开发 ubpf 和 rbpf 程序可能需要一个特定的工具链，这对于一些用户可能是一个障碍。ubpf 只有一个有限的哈希映射实现，对某些用户来说可能不够。

#### **rbpf**

[rbpf](https://github.com/qmonnet/rbpf) 受 uBPF 的强烈影响，但重点是 Rust，这是一种因其内存安全保证而著称的语言。创建 rbpf 是由于想要探索 eBPF 和 Rust 的交集。虽然没有广泛采纳，但 rbpf 的知名用户包括 Solana 团队，他们使用它为带有 eBPF 驱动的智能合约的区块链工具。rbpf 的一个优势在于其许可证 (MIT)，允许在各种项目中广泛重用。rbpf 也缺乏 eBPF 映射支持，并且仅为 x86_64 提供 JIT 支持。

#### **bpftime**

基于 LLVM JIT/AOT 构建的 [bpftime](https://github.com/eunomia-bpf/bpftime) 是专为用户空间操作设计的尖端高性能 eBPF 运行时。它以其快速的 Uprobe 能力和 Syscall 钩子脱颖而出，尤其是 Uprobe 性能比内核提高了十倍。此外，bpftime 提供编程 syscall 钩子、共享内存映射和与熟悉的工具链（如 libbpf 和 clang）的兼容性。其设计解决了一些内核 eBPF 的限制，并在某些方面超越了像 Wasm 运行时这样的插件系统。

## 为什么拥有eBPF的用户空间版本会引人关注？

eBPF，虽然因其在内核空间的操作而著称，但在其用户空间的适应中观察到了越来越多的兴趣。以下是将 eBPF 迁移到用户空间引起技术人员关注的原因：

### 提升性能

在内核操作中，eBPF 的 Uprobe 组件经常受到性能低效的困扰，主要是由于上下文切换引入的开销。在对延迟敏感的应用中，这些低效可能是有害的，影响实时监控和数据处理。通过转到用户空间，eBPF 可以绕过这些与上下文切换相关的延迟，从而实现更优化的性能。像 `bpftime` 这样的运行时就是这一点的典型，与其内核对应物相比，它们提供了显著的性能改进。

### 灵活性和集成

用户空间 eBPF 运行时是灵活性的拥护者。与某些替代方案（如 Wasm 运行时，可能需要手动集成）不同，用户空间 eBPF 提供了自动工具化的恩惠。这意味着它们可以无缝地引入正在运行的进程，无需繁琐的重新启动或重新编译，确保更顺畅的操作流程。

### 增强的安全性

在内核模式下操作，eBPF 程序需要 root 访问权限，这可能无意中扩大了攻击面，使系统容易受到像容器逃逸或甚至可能的内核利用这样的漏洞的影响。然而，用户空间运行时在这个高风险区域之外操作。通过在用户空间中工作，它们要求的特权更少，从本质上减少了安全漏洞的潜在途径。

### 调试和许可灵活性

用户空间 eBPF 运行时的一个固有优势是开发者可以轻松地调试他们的代码。在用户空间解释器中集成断点的可访问性比内核 eBPF 中相对受限的调试能力有显著的优势。此外，用户空间 eBPF 运行时的许可灵活性，通常在像 Apache 或 MIT 这样的许可下提供，确保它们可以与各种项目（包括专有项目）配对，绕过与内核代码相关的 GPL 约束。

## 使用案例：现有的 eBPF 用户空间应用

用户空间 eBPF 正在许多值得注意的项目中使用，每个项目都利用 eBPF 的独特功能来增强它们的功能。以下是用户空间 eBPF 目前在各种应用中的使用方式：

1. [**Oko:**](https://github.com/Orange-OpenSource/Oko)

   Oko 是 Open vSwitch-DPDK 的扩展，提供了与 BPF 程序的运行时扩展。它允许使用 BPF 程序在用户空间处理数据包，提供灵活的数据包处理，并促进 Open vSwitch 与其他系统的集成。

1. [**DPDK eBPF 支持:**](https://www.dpdk.org/wp-content/uploads/sites/35/2018/10/pm-07-DPDK-BPFu6.pdf)

   DPDK (数据平面开发套件) eBPF 支持通过允许在用户空间使用 eBPF 程序来促进快速的数据包处理，这些程序可以加载并运行以分析网络数据包。这增强了网络应用的灵活性和可编程性，无需修改内核。

1. [**Solana:**](https://solana.com/)

   Solana 利用 eBPF 实现一个 JIT (即时)编译器，这对于在其区块链网络上执行智能合约是至关重要的。使用 eBPF 确保了安全性、性能和架构中立性，从而允许在 Solana 区块链上的验证器节点上高效地执行智能合约。

1. [**eBPF for Windows (进行中的工作):**](https://github.com/microsoft/ebpf-for-windows)

   该项目旨在将 Linux 生态系统中熟悉的 eBPF 工具链和 API 带到 Windows，允许在 Windows 之上使用现有的 eBPF 工具链。这展示了将 eBPF 的功能扩展到 Linux 之外的有前景的尝试，尽管它仍然是一个进行中的工作。

使用 eBPF 的这些应用的好处包括：

- **灵活性:** eBPF 提供了一个灵活的框架，用于在内核或用户空间中运行程序，使开发人员能够扩展现有系统的功能，而无需修改其核心代码。
- **性能:** 通过允许 JIT 编译和高效的数据包处理，eBPF 可以显著提高网络应用和区块链智能合约执行的性能。
- **安全性和安全性:** eBPF 框架为验证程序执行前的安全属性提供了机制，从而确保了其集成的系统的完整性和安全性。
- **跨平台能力:** eBPF 指令集的架构中立性使得跨平台兼容性成为可能，如 Solana 项目和进行中的 eBPF for Windows 所示。

这些属性使 eBPF 成为增强各种应用的强大工具，从网络处理到区块链智能合约执行，再到更多。还有一些论文讨论了在用户空间中使用 eBPF 的用途：

1. [**RapidPatch: 用于实时嵌入式设备的固件热修复**](https://www.usenix.org/conference/usenixsecurity22/presentation/he-yi):
   
   本文介绍了一个名为 RapidPatch 的新的热修复框架，该框架旨在通过在异构嵌入式设备上安装通用修复程序来促进修复的传播，而不会中断它们上运行的其他任务。此外，RapidPatch 提出了两种类型的 eBPF 补丁，用于不同类型的漏洞，并开发了一个 eBPF 补丁验证器以确保补丁安全。

2. [**Femto-Containers: 低功耗 IoT 微控制器上的小型软件功能的轻量级虚拟化和故障隔离**](https://arxiv.org/abs/2210.03432):
   
   本文介绍了 Femto-Containers，这是一个新颖的框架，允许在低功耗 IoT 设备上安全地部署、执行和隔离小型虚拟软件功能。该框架在 RIOT 中实现并提供，RIOT 是一个受欢迎的开源 IoT 操作系统，强调在低功耗 IoT 设备上安全地部署、执行和隔离小型虚拟软件功能。该论文讨论了在一个常见的低功耗 IoT 操作系统 (RIOT) 中集成的 Femto-Container 主机引擎的实现，增强了其在标准的 IPv6/6LoWPAN 网络上按需启动、更新或终止 Femto-Containers 的能力。

这些论文深入探讨了固件补丁和轻量级虚拟化方面的相关进展，展示了针对实时嵌入式系统和低功耗 IoT 微控制器领域的关键挑战的创新。

## 用户空间 eBPF 运行时 vs Wasm 运行时

在不断发展的云原生和边缘计算领域中，eBPF (扩展的伯克利数据包过滤器) 和 Wasm (WebAssembly) 都已成为强大的工具。但它们都有自己的设计原则和权衡取舍。

### eBPF 和 Wasm 的对比

**eBPF**:

- **哲学**：eBPF 优先考虑性能，通常是实时内核操作和高吞吐量网络任务的首选。
- **安全性**：虽然性能是首要任务，但 eBPF 通过使用验证器来确保安全性，确保所有程序都可以安全地运行，而不会导致内核恐慌或无限循环。

**Wasm**:

- **哲学**：Wasm 最初是为网络设计的，更强调可移植性和安全性。它的目标是执行代码，速度几乎与运行原生机器代码一样快，并确保在像网络浏览器这样的敌对环境中的安全性。
- **安全性**：Wasm 的主要安全模型围绕软件故障隔离 (SFI)。该模型通过强制沙箱执行来保证安全执行，尽管这可能会引入一些运行时开销。

对于这两种技术，都依赖底层库进行复杂操作。例如，Wasm 依赖像 `Wasi-nn` 这样的库进行神经网络操作。然而，当与这些外部API交互时，特别是在Wasm的上下文中，需要额外的验证和运行时检查，有时会导致大量的性能开销。eBPF 内嵌在主机中时，利用其验证器确保代码安全，提供了更以性能为中心的方法。

在语言支持方面，尽管 eBPF 的特定和专业性质意味着有限的语言支持，但由于 Wasm 是为在浏览器中执行应用而设计的，所以它拥有更广泛的语言组合。

### 结论

用户空间 eBPF 运行时是一个令人兴奋的发展，它扩展了 eBPF 超越内核的功能。正如本文所强调的，与基于内核的 eBPF 相比，它们提供了如增强的性能、灵活性和安全性等引人注目的好处。像 bpftime 这样的运行时展示了实质性加速的潜力，在某些方面，如低级性能，甚至超过了像 Wasm 运行时这样的替代方案。

随着像 RapidPatch 和 Femto-Containers 这样的创新框架分别利用用户空间 eBPF 进行补丁和轻量级虚拟化，我们正在见证解决嵌入式系统和 IoT 领域的关键挑战的开创性用例。随着 eBPF 在用户空间的继续发展，我们可以期望有更多的创意应用，增强从智能合约到网络协议的一切。

虽然像 Wasm 这样的替代方案当然有其位置，重点放在 web 的可移植性和安全性上，但 eBPF 的专业性质使其在性能关键任务上具有优势。最终，两者之间的选择取决于特定的用例和优先级。随着它们的持续发展，用户空间 eBPF 运行时正在巩固其作为云原生技术堆栈不可或缺的一部分的地位，提供了安全性、效率和创新的无与伦比的组合。

> 我们鼓励读者深入探索用户空间 eBPF 的世界，从我们的 bpftime GitHub 仓库开始：<https://github.com/eunomia-bpf/bpftime> 贡献、反馈或简单地使用这个工具都可以推进这一事业，为社区提供宝贵的见解。
>
> 如果您在研究中使用我们的项目，请[引用我们的仓库](https://github.com/eunomia-bpf/bpftime/blob/master/CITATION.cff)。
